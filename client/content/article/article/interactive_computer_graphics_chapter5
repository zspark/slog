# 光照基本组成
有了光，我们的物体才有了影，“光影”不分家。光有强弱的不同，物体表面不同的光强表达出了物体的形。影很少说到强弱（有些影比较淡是因为有环境光或者物体表面的反射光参与了进来），但影的存在表达出了物体的依托，也就是位置关系。

我们在CG科学中，经常使用的光有三种：环境光（ambient）、漫射光（diffuse）、镜面光（specular）

* 环境光：这种光在真实世界中其实是不存在的，但在CG中必须有的原因在于我们非常有必要给物体整体上个最基本的亮度与轮廓，不然在监视器上就是漆黑一片（如果光照不到），想象一个全封闭的房间，墙是纯黑的，里面有一盏灯，于是整个房间昏昏暗暗，但是如果把墙涂成白色，同样的孤灯下马上就觉得明亮许多，这个整体的亮度差，我们姑且就拿来形容是真实世界的“环境光”，究其真实原因还是白墙对灯光的漫射，是种标准的漫射光。
* 漫射光：漫射光的存在给世界提供了粗略的明暗效果，使得物体出现了基本的形状，想象一下阴天的户外吧，看不见太阳，但外面的东西依然可以辨认，注意观察的话你会发现，这种情况下基本或者根本看不见影子，较远处有2棵树，不熟悉环境的话便会很难判断出孰近孰远（抛开对树干粗细等生活经验）。想象到这里你应该能对漫射光有了正确的感性认知。
* 镜面光：就像激光一样，“直来直去”。照不到的地方肯定形成影子，镜面光的存在让物体有了鲜明的明暗效果，同时有了依托（影子，让人正确感知位置关系）。回到上面我们想象的场景中，倘若正是个风和日丽的下午，看一下2棵树的影子与太阳的位置，应该就更有依据判断出它们孰近孰远。

# Phong模型
我们来简单介绍下一个被称为phong（冯式）光照模型的公式，三种光的强度分别用L加其英语单词首字母做下标表示。

## 漫射光贡献
%mimg%Attach:image-cg-lighting.jpg[[<<]]光束照射到平面上发生漫射现象，u为光线反方向的向量，n为平面法向量%%

一束光照射在表面上，图中的-u方向，假如该物体是个石灰平面（非常粗糙），那么这束光将会被均匀反射到四面八方（实际情况是虽然反射到了四面八方，但是并不均匀，可能某些方向比较集中些）。我们将能均匀反射到四面八方的表面叫做“理想漫反射表面”（所谓理想的就是不存在的，CG中部分渲染是将表面看作理想的漫反射表面），以便简化问题，简化模型。根据Lambert定理可知只有光的垂直分量才对物体表面的亮度有贡献，也就是图中OC向量，OC的计算可以用点积进行。所以漫射光对最终光强度的贡献为：

\\[
L_d^{'}=L_d\hat {\mathbf u} \cdot \hat {\mathbf n}
\\]

我们分析下w，它是光从表面的‘背面’射向了O点，如果表面透明，完全需要考虑，不过我们这里只考虑不透明的情况，这种情况下w光对表面没有任何贡献，观察到对表面不做贡献的所有光线在图中的方向都是与n反向的，于是我们需要调整上面的模型如下：

\\[
L_d^{'}=L_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)
\\]

公式到此依然需要解决2个问题：

* 现在的漫射光模型应该得到的是光线u对表面O的所有光强贡献，但理想的漫射表面是将该贡献强度射向了四面八方，怎么着也不可能是全部的强度射向一个方向。解决这个问题我们只需要给模型加上一个大于0，小于1的参数$\\(k_d\\)，表示所有贡献的百分之多少射向了周围（均匀反射），于是合乎情理；
* 第二个问题就是光的能量会随着传播距离而衰减（反比于距离的平方，【物理】），因此需要加上距离衰减因子,最基本的想法就是将漫射强度除以表面到光源的距离d的平方，这样距离越远，最终的强度就越小。但在CG大部分实际应用中是将衰减因子写成一个一元二次代数式的形式（a、b、c为常数）： \\(F=\frac {1}{a+bd+cd^2}\\) 这样写的原因在于不至于将距离光源近的物体照的太亮，而远的太暗。究其根本原因是在于我们真实的世界是各种光源、光线（反射光、折射光、漫射光、散射光等等）复杂叠加的结果，而此处仅仅将光源想象成一个点，将复杂叠加尽量简单化。

<blockquote class="note">我们在Phong模型中不考虑光从物体照射进眼睛这段距离的衰减。</blockquote>

> 用点发光体照明一个场景是真实光照效果的一个简单逼近。
>
> --- 摘自《计算机图形学》第三版中文。

最终的漫射光模型如下：

\\[L_d^{'}=\frac {1}{a+bd+cd^2}k_dL_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)\\] 

## 镜面光贡献
[{{ :computer-graphics:interactive-computer-graphics:cg5_lighting:model2.jpg?direct&200|光束照射在平面上发生反射现象，r是反射光线方向，v为指向人眼（照相机）的方向。}}]

镜面光在推理上与漫射光一样，只是加了额外的“高光系数”（或者叫做“角强度衰减系数”，参考《计算机图形学》）$\alpha$，最终公式见下。

\\[
L_s^{'}=\frac {1}{a+bd+cd^2}k_sL_s  max(({\hat {\mathbf r} \cdot \hat {\mathbf v}})^\alpha,0)
\\] 

公式1.2中向量r（reflect）与v（view）分别表示入射光线u针对平面法线n的反射光线与平面点O到观察者的方向向量。\\(k_sL_s{\hat {\mathbf r} \cdot \hat {\mathbf v}}\\)就是有多少反射光的强度可以进入人眼。由于r与v都是归一化向量，所以\\({\hat {\mathbf r} \cdot \hat {\mathbf v}}=\cos \theta\\)（\\(\theta\\)是r与v的夹角）。\\(f(\theta)=(\cos\theta)^\alpha\\)这个函数在不同参数下的曲线图；

当\\(\alpha=1\\)时，函数就是标准的余弦函数（图中显示部分形状），这种情况下，只要\\(\theta\\)不超过90度，或多或少会有反射光的部分能量射向v方向。此时我们看到的就是明显的渐变过度。当\\(\alpha=5\\)时，从图中看到预计在\\(\theta=0.3\frac{\pi}{2}\\)时，函数f就等于0，这就说明\\(0.3\frac{\pi}{2}<\theta<\frac{\pi}{2}\\)的时候函数f是0，也就是说此时反射光不对v方向有任何光强贡献。

[{{ :computer-graphics:interactive-computer-graphics:cg5_lighting:shininess.jpg?direct&200|不同高光系数的效果 图片来自《交互式计算机图形学》E文第六版版}}]

## 环境光贡献
由于环境光随处都在，就是为了整体提高物体的亮度，所以它对最终亮度有全部的贡献，为了统一起见，我们也加上一个系数\\(k_a\\);

## 整合
最基本的phong光照模型就是这三种光的线性组合，公式见下。因为公式中使用了不符合物理规律的地方（比如不正确的距离衰减系数、将光源模拟成一个点等），所以我们将其称作经验公式。

\\[L=\frac {1}{a+bd+cd^2}(k_dL_d  max(\hat {\mathbf u} \cdot \hat {\mathbf n},0)+ max(({\hat {\mathbf r} \cdot \hat {\mathbf v}})^\alpha,0))+k_aL_a\\]

%mimg%Attach:image-cg-phong.jpg 三种不同光线对物体的贡献，图片来自维基百科%%

跟着公式与上面的图像，我们再次进行说明。第一张子图是只有环境光效果，由于处处存在环境光且强度相同，因此没有明暗的变化，仅仅给物体涂上了一层基础亮度与基本的轮廓，让观察者知道那里有个东西。从图中我们明显看不出其表面的形状，直观感觉像是2个哑铃。第二章子图是仅仅有漫射光的情况，我们看到了物体表面的形，但是阴暗的地方与背景融为一体，因为我们没有给物体涂上基本的亮度。第三张子图是只有镜面光的效果，由于\\(\alpha\\)设置可能比较高，导致我们只能视觉感知到反射光线明显朝向观察者方向的光亮，其他方向一律剔除，这才形成了图中星星斑点。第四张子图就是前三者的组合，他比第一张、第二张整体明亮，因为亮度叠加了。既能看到整体轮廓，又能看到正对表面的形状，还有高光表达物体表面“光滑”“明亮”的物体特征，这样就算完成了一次较好的渲染。

## 反射向量的计算
[{{ :computer-graphics:interactive-computer-graphics:cg5_lighting:reflection.jpg?direct&200|反射向量计算示意图}}]

向量r是u针对n的反射向量，很明显r是通过先给出u与n后才能计算出来的。从公式1.2中知道想要得到最终镜面光的贡献，必须事先计算r，参见图4。我们将r平移到以U为起始点的位置，从而得到一个等腰三角形OUU'，其中U'点肯定在向量n所在的直线上。假设 \\( \mathbf u +\mathbf r=x\mathbf n \\) 如果我们能得到\\(x\mathbf n\\)的具体数据就能通过减法得到r。通过观察与数学简单判断得出：

\\[x\mathbf n=2\overrightarrow{OC};
\overrightarrow{OC}=(\mathbf u \cdot \hat {\mathbf n})\hat {\mathbf n}\\]

于是反射向量的计算公式为：

\\[\mathbf r=2(\mathbf u \cdot \hat {\mathbf n})\hat {\mathbf n}-\mathbf u\\]

# 改进了的Phong模型

## Blinn-Phong模型
[{{ :computer-graphics:interactive-computer-graphics:cg5_lighting:model_half.jpg?direct&200|半角向量，图中h为半角向量，其他向量含义不变。}}]

接下来我们继续查看公式1.2。现在我们知道了r的具体数据，那么计算镜面光不是问题。进一步的发展要么就是设计新的光照模型要么就是优化Phong模型。改进的Phong模型就是从优化的角度进行了发展。前辈们通过一个叫半角向量的思想优化了这个模型。


图中所示，红色向量h就是u与v的所成角的半角向量，其方向是\\(\hat{\mathbf u}+\hat{\mathbf v}\\)，大小的话一般都使用归一化的向量。可以简单的证明n与h形成的角度是r与v形成角度的一半，如此一来我们可以近似的将\\(\mathbf v \mathbf r\\)的点积计算写成\\(\mathbf n \mathbf h\\)的形式。简单分析一下计算r时候的开销：7个乘法运算、5个加法运算。而计算h的开销：3个乘法、4个加法。除了性能上的提升以外，新向量h也会在其他方面有所贡献。**通过将rv的运算改成近似的使用nh的形式，我们将此改进的Phong模型称为：Blinn-Phong模型。**

# 着色
我们有三种基本的着色方案：

* flat着色：就是一个三角面一种颜色，具体颜色值是要么来自第一个顶点、要么来自最后一个顶点颜色，通过下面OpenGL函数指定：glProvokingVertex(GL_FIRST_VERTEX_CONVENTION)、glProvokingVertex(GL_LAST_VERTEX_CONVENTION);
* 高氏着色：对光照进行插值的着色方案；
* 冯氏着色：对法线进行差值的着色方案；


https://en.wikipedia.org/wiki/Phong_reflection_model   
http://blog.csdn.net/xiajun07061225/article/details/7660810
